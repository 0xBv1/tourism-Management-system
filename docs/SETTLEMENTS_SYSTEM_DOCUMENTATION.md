# نظام التسويات الشهرية للمرشدين والمندوبين

## نظرة عامة
تم إنشاء نظام شامل لإدارة التسويات الشهرية للمرشدين والمندوبين في نظام إدارة السياحة. يتيح النظام حساب المبالغ المستحقة بناءً على الرحلات المنجزة والأسعار المتفق عليها.

## المميزات الرئيسية

### 1. إدارة التسويات
- إنشاء تسويات شهرية/أسبوعية/ربعية/سنوية/مخصصة
- حساب تلقائي للمبالغ المستحقة
- إدارة العمولات والضرائب والخصومات والمكافآت
- تتبع حالة التسوية (في الانتظار، محسوب، معتمد، مدفوع، مرفوض)

### 2. أنواع التسويات
- **شهرية**: تسويات شهرية منتظمة
- **أسبوعية**: تسويات أسبوعية
- **ربعية**: تسويات كل 3 أشهر
- **سنوية**: تسويات سنوية
- **مخصصة**: تسويات لفترة محددة

### 3. حساب العمولات
- **نسبة مئوية**: عمولة كنسبة مئوية من إجمالي المبلغ
- **مبلغ ثابت**: عمولة بمبلغ ثابت
- **بدون عمولة**: لا توجد عمولة

### 4. إدارة المدفوعات
- تسجيل طرق الدفع المختلفة (نقداً، تحويل بنكي، شيك، أخرى)
- تتبع أرقام المراجع
- إدارة الضرائب والخصومات والمكافآت

## الملفات المنشأة

### النماذج (Models)
- `app/Models/Settlement.php` - نموذج التسوية الرئيسي
- `app/Models/SettlementItem.php` - نموذج عناصر التسوية

### الـ Enums
- `app/Enums/SettlementStatus.php` - حالات التسوية
- `app/Enums/SettlementType.php` - أنواع التسويات
- `app/Enums/CommissionType.php` - أنواع العمولات

### الـ Controllers
- `app/Http/Controllers/Dashboard/SettlementController.php` - تحكم في التسويات

### الـ Services
- `app/Services/SettlementService.php` - منطق حساب التسويات

### الـ Requests
- `app/Http/Requests/Dashboard/SettlementRequest.php` - التحقق من صحة البيانات

### الـ DataTables
- `app/DataTables/SettlementDataTable.php` - جدول البيانات للتسويات

### الـ Commands
- `app/Console/Commands/GenerateMonthlySettlements.php` - توليد التسويات الشهرية تلقائياً

### الـ Seeders
- `database/seeders/SettlementSeeder.php` - بيانات تجريبية للتسويات
- `database/seeders/SettlementPermissionSeeder.php` - صلاحيات التسويات

### الـ Migrations
- `database/migrations/2025_10_14_094838_create_settlements_table.php` - جدول التسويات
- `database/migrations/2025_10_14_094845_create_settlement_items_table.php` - جدول عناصر التسوية

### الـ Views
- `resources/views/dashboard/settlements/index.blade.php` - صفحة الفهرس
- `resources/views/dashboard/settlements/create.blade.php` - صفحة الإنشاء
- `resources/views/dashboard/settlements/show.blade.php` - صفحة العرض
- `resources/views/dashboard/settlements/edit.blade.php` - صفحة التعديل
- `resources/views/dashboard/settlements/modals/` - النوافذ المنبثقة

## كيفية الاستخدام

### 1. إنشاء تسوية جديدة
1. انتقل إلى "Settlements" في القائمة الجانبية
2. اضغط على "Create Settlement"
3. اختر نوع المورد (مرشد/مندوب)
4. اختر نوع التسوية والفترة
5. حدد إعدادات العمولة والضرائب
6. احفظ التسوية

### 2. حساب التسوية
1. بعد إنشاء التسوية، اضغط على "Calculate Settlement"
2. سيتم حساب المبالغ تلقائياً بناءً على الحجوزات المكتملة
3. ستظهر تفاصيل جميع الرحلات في الفترة المحددة

### 3. اعتماد التسوية
1. بعد الحساب، يمكن اعتماد التسوية
2. يمكن إضافة ملاحظات إضافية عند الاعتماد

### 4. تسجيل الدفع
1. بعد الاعتماد، يمكن تسجيل الدفع
2. اختر طريقة الدفع وأضف رقم المرجع إن وجد

### 5. توليد التسويات الشهرية تلقائياً
```bash
php artisan settlements:generate-monthly --month=10 --year=2024
```

## الصلاحيات المطلوبة

- `settlements.list` - عرض قائمة التسويات
- `settlements.create` - إنشاء تسوية جديدة
- `settlements.edit` - تعديل التسوية
- `settlements.delete` - حذف التسوية
- `settlements.show` - عرض تفاصيل التسوية
- `settlements.calculate` - حساب التسوية
- `settlements.approve` - اعتماد التسوية
- `settlements.reject` - رفض التسوية
- `settlements.mark-paid` - تسجيل الدفع

## العلاقات مع النماذج الأخرى

### مع المرشدين والمندوبين
- كل مرشد/مندوب له عدة تسويات
- كل تسوية تنتمي لمرشد أو مندوب واحد

### مع حجوزات الموارد
- كل تسوية تحتوي على عدة عناصر (SettlementItem)
- كل عنصر مرتبط بحجز مورد محدد

### مع ملفات الحجز
- التسويات مرتبطة بملفات الحجز من خلال حجوزات الموارد

## التطوير المستقبلي

1. **تقارير متقدمة**: إضافة تقارير مفصلة للتسويات
2. **إشعارات**: إشعارات عند استحقاق التسويات
3. **تصدير**: تصدير التسويات إلى Excel/PDF
4. **تكامل مع أنظمة الدفع**: ربط مباشر مع أنظمة الدفع الإلكتروني
5. **تحليلات**: تحليلات أداء المرشدين والمندوبين

## ملاحظات مهمة

- التسويات يمكن تعديلها فقط في حالة "في الانتظار"
- بعد الحساب، يجب اعتماد التسوية قبل تسجيل الدفع
- يمكن رفض التسوية مع إضافة سبب الرفض
- النظام يحسب المبالغ تلقائياً بناءً على الحجوزات المكتملة فقط

